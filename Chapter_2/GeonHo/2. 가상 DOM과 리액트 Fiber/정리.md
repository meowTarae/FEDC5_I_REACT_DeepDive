## 2.2 가상 DOM과 리액트 파이버

리액트의 특징 중 가장 많이 언급되는 것 중 하나는 바로 가상 DOM이다. <br>
리액트 가상 DOM과 실제 DOM의 차이에 대해 알아보자.

### 2.2.2 가상 DOM의 탄생 배경

브라우저가 웹페이지를 렌더링 하는 과정은 매우 복잡하고 많은 비용이 든다. <br>  
또한 반응형 웹페이지를 위해 렌더링 이후에도 인터렉션으로 웹페이지가 변경되는 상황 또한 고려해야 한다.

특히 SPA일수록 DOM을 관리하는 과정에서 부담해야 할 비용이 더 커진다.

사용자의 인터렉션에 따라 DOM의 모든 변경 사항을 추적하는 것은 개발자 입장에서 너무나 수고스러운 일이기에, <br>
인터랙션에 대한 변경 사항만을 추적하여 변경 사항을 최소화하는 방법을 고안했다.

이를 위해 가상 DOM이라는 개념이 등장했다. <br>
가상 DOM은 웹페이지가 표시해야 할 DOM을 일단 메모리에 저장하고, <br>
리액트가 실제 변경에 대한 준비가 완료되었을 때 실제 브라우저 DOM에 반영한다.

이렇게 DOM 계산을 브라우저가 아닌, 메모리에서 계산하는 과정을 한 번 거치면, 렌더링 과정을 최소화 할 수 있다.

가상 DOM은 실제 DOM 보다 무조건 빠르다는 것은 아니다. <br>
웬만한 상황에서 웬만한 앱을 만들 수 있을 정도로만 빠르다.

### 2.2.3 리액트 파이버

가상 DOM을 만드는 과정을 리액트는 어떻게 처리하고 있을까? <br>
가상 DOM과 렌더링 과정 최적화를 가능하게 해주는 리액트 파이버가 있다.

### 리액트 파이버란?

가상 DOM과 실제 DOM을 비교해 변경 사항을 수집하여, 둘 사이의 차이가 있다면 <br>
파이버를 기준으로 화면에 렌더링을 요청하는 역할을 한다.

파이버는 다음과 같은 일을 한다.

- 작업을 작은 단위로 분할하고 쪼갠 다음, 우선순위를 매긴다.
- 이러한 작업을 일시 중지하고 나중에 다시 시작할 수 있다.
- 이전에 했던 작업을 다시 재사용하거나 필요하지 않은 경우에는 폐기할 수 있다.

또한, 이 모든 과정은 `비동기`로 일어난다.

(참고: 과거에는 동기적으로 스택을 이용하여 작업을 처리하여 리액트의 비효율성을 불러일으켰다.)

파이버는 하나의 작업 단위로 구성돼있다. <br>
리액트는 하나의 작업 단위를 처리하고 `finishedWork()`라는 작업 단위를 반환한다. <br>
그리고 이 작업을 커밋해, 실제 브라우저 DOM에 가시적인 변경 사항을 만들어 낸다. <br>
이러한 단계는 다음 두 단계로 나눌 수 있다.

- 렌더 단계에서, 리액트는 사용자에게 노출되지 않는 모든 비동기 작업을 수행한다. <br>
  이 단계에서 파이버의 작업, 우선순위를 지정하거나 중지시키거나 버리는 등의 작업이 일어난다.
- 커밋 단계에서는 DOM에 실제 변경 사항을 반영하기 위한 작업, `commitWork()`가 실행되는데, 이 과정은 동기적으로 일어난다.

(참고: 리액트 파이버는 단순한 JS 객체로 구성되어 있다.)

#### 파이버와 리액트 요소의 차이점?

- 리액트 요소 : 렌더링이 발생할 때 마다 새롭게 생성됨.
- 파이버 : 가급적 재사용 된다.

<br><br>

리액트는 가상 DOM이 아닌 Value UI, 즉 값을 가지고 있는 UI를 관리하는 라이브러리이다. <br>
파이버의 객체 값에서도 알 수 있듯, 리액트의 핵심 원칙은 UI를 문자열, 숫자, 배열과 같은 값으로 관리한다는 것이다. <br>

변수에 이러한 UI 관련 값을 보관하고, 리액트의 JS 코드 흐름에 따라 이를 관리하고 표현하는 것이 바로 리액트다.

#### 리액트 파이버 트리

파이버 트리는 리액트 내부에서 2개가 존재한다.

- 현재 모습을 담은 파이버 트리
- 작업 중인 상태를 나타내는 workInProgress 트리

더블 버퍼링 ? <br>
=> 리액트 파이버의 작업이 끝나면, 리액트는 단순히 포인터만 변경해 workInProgress 트리를 현재 트리로 바꿔버린다.

<br>
컴퓨터 그래픽스 분야 용어이다. <br>
그래픽을 통해 화면에 표시되는 것을 그리기 위해서는 내부적으로 처리를 거쳐야한다. <br>
이때, 사용자에게 미처 다 그리지 못한 모습을 보여줄 수 있다. <br>

이를 방지하기 위해 더블 버퍼링이라는 보이지 않는 곳에서 그 다음으로 그려야 할 그림을 미리 그린 후, <br>
이것이 완성되면 현 상태를 새 그림으로 바꾸는 기법을 사용한다.

이러한 더블 버퍼링을 위해 트리가 두 개 존재하는 것이다. <br>
더블 버퍼링은 커밋 단계에서 수행된다.

<br><br>

#### 파이버의 작업 순서

- 리액트는 beginWork() 함수를 실행해 파이버 작업을 수행하는데, 더 이상 자식이 없는 파이버를 만날 때까지 트리 형식으로 시작된다.
- 위 작업이 끝나면, completeWork() 함수를 실행해 파이버 작업을 완료한다.
- 형제가 있다면 형제로 넘어간다.
- 2, 3번 과정이 모두 끝났다면, return으로 돌아가 자신의 작업이 왼료됐음을 알린다.

<br><br>

### 2.2.4 파이버와 가상 DOM

리액트 컴포넌트에 대한 정보를 1:1로 가진 것이 파이버.

이 파이버는 리액트 아키텍처 내부에서 비동기로 이뤄진다. <br>
이러한 비동기 작업과 달리, 실제 브라우저 DOM에 반영되는 것은 동기적으로 일어나야 하고, <br>
또 처리하는 작업이 많아 화면에 불완전하게 표시될 수 있는 가능성이 높으므로 <br>
이러한 작업을 가상, 즉 메모리상에서 먼저 수행한 후 최종 결과물만 실제 브라우저 DOM에 적용하는 것이다.

즉, 리액트 가상 DOM은 속도 측면에서의 향상보다는, 개발자가 DOM을 수동으로 하나하나 변경하다보면 생길 수 있는 변수들에 대한 어려움을 관리해줌으로써 웹 앱을 효율적으로 유지보수하고 관리해주는 측면으로 보는 역할이다.

가상 DOM과 리액트의 핵심은 브라우저의 DOM을 더욱 빠르게 반영하는 것이 아니라, 바로 값으로 UI를 표현하는 것이다.
